# 媒体播放器扩展（v1.4.2）

基于 SillyTavern 老版本图片播放器（v1.3.0）重构迭代，安全集成全媒体播放能力，聚焦稳定性修复与功能优化，保留老版本核心交互逻辑，同时解决新版本潜在的脚本崩溃、状态不同步等问题，适配多系统环境。

st_image_player/
├── 核心配置文件
│ ├── manifest.json # 扩展元数据配置（ID、依赖、入口等）
│ ├── requirements.txt # 后端服务依赖（Flask、WebSocket 等）
│ └── README.md # 项目说明文档
├── 入口与初始化
│ └── index.js # 扩展入口，负责模块加载、初始化流程控制
├── 后端服务
│ └── image_service.py # 媒体服务后端（文件扫描、API 提供、WebSocket 支持）
├── 核心基础模块（core/）
│ ├── deps.js # 依赖管理（安全获取 toastr、注册模块）
│ └── eventBus.js # 事件总线（跨模块通信中枢）
└── 功能模块（modules/）
├── utils.js # 工具函数（目录验证、过渡效果等）
├── settings.js # 配置管理（保存/读取扩展设置）
├── api.js # 后端接口封装（媒体列表、服务状态等 HTTP 请求）
├── websocket.js # 实时通信（与后端 WebSocket 连接管理）
├── mediaPlayer.js # 播放核心（媒体显示、状态管理、播放控制）
├── aiEvents.js # AI 事件处理（监听 AI/用户消息触发媒体切换）
└── ui.js # 界面组件（播放器窗口、设置面板创建与事件绑

## 一、核心功能

### 1. 基础播放能力（向下兼容老版本）

- **全媒体格式支持**
  - 图片：PNG、JPG、JPEG、GIF、BMP、WebP、APNG
  - 视频：WebM、MP4、OGV、MOV、AVI、MKV
- **经典播放控制**
  - 播放模式：随机播放（自动规避重复媒体，列表循环重置提示）、顺序播放（支持循环切换）
  - 自动切换：AI 回复检测、玩家消息检测（优化冷却逻辑，默认 3 秒防误触，可自定义）
  - 窗口交互：拖拽标题栏移动、右下角手柄调整大小、锁定功能（防止误操作）
  - 图片过渡：淡入淡出、滑动、缩放、无效果（4 种可选，适配不同场景）

### 2. v1.4.0+ 新增功能（无复杂依赖）

- **视频专属控制**
  - 进度管理：拖拽进度条定位、加载进度可视化（已加载部分灰色显示）
  - 音量调节：0-100% 精细控制（静音/低音量/高音量图标区分）
  - 循环播放：独立开关（开启后不触发自动切换，避免打断播放）
  - 控制栏自定义：可隐藏进度条、音量控制、循环按钮、时间戳（按需简化界面）
- **媒体筛选与管理**
  - 一键筛选：控制栏右侧快速切换「所有媒体/仅图片/仅视频」（状态同步到设置面板与扩展菜单）
  - 大小限制：自定义图片（1-50MB）、视频（10-500MB）最大尺寸（超限制文件自动过滤）
  - 无效清理：一键移除不存在/超限制的媒体文件（操作前弹窗确认，避免误删）
- **视觉优化**
  - 边框隐藏模式：仅显示媒体内容，鼠标悬浮显示视频控制栏（无操作 3 秒自动隐藏）
  - 媒体信息显示：底部显示文件名与类型（可开关，避免遮挡内容）
- **性能与稳定性**
  - 预加载策略：图片默认预加载、视频可选预加载（大文件建议关闭以节省资源）
  - WebSocket 实时更新：媒体库新增/删除/修改时自动同步（断连后 10 秒自动重连）
  - 服务轮询：可自定义轮询间隔（默认 30 秒，平衡实时性与资源占用）

## 二、安装步骤（兼容 Windows/macOS/Linux）

### 1. 扩展部署

将扩展文件夹放入 SillyTavern 的 **`public\scripts\extensions\third-party`** 目录（无该目录需手动创建）。

## 三、使用说明

### 2. 视频播放注意事项

- **浏览器自动播放限制**：Chrome、Edge 等浏览器需手动点击视频触发首次播放（浏览器政策限制，无法绕过）。
- **大视频优化**：超过 200MB 的视频建议关闭「视频预加载」，低配置设备可降低轮询频率（减少资源占用）。
- **循环播放逻辑**：开启视频循环后，AI/玩家消息检测不会触发切换（避免打断连续播放，关闭循环后恢复）。
- **断点续传**：视频支持断点续传（刷新页面或重新加载后从上次播放位置继续）。

## 四、故障排查（高频问题解决方案）

### 2. 视频加载失败

- 症状：视频显示空白或提示「加载失败」。
- 解决步骤：
  1. 检查文件路径：避免含特殊字符（如 `*`、`?`、空格），建议使用英文路径。
  2. 确认文件完整性：尝试用本地播放器打开（如 VLC），排除文件损坏。
  3. 浏览器兼容性：优先使用 WebM/MP4 格式（OGV/MKV 部分浏览器支持不佳）。
  4. 大小限制：确认视频未超过设置的最大尺寸（默认 100MB，可在设置中调整）。

### 3. 自动切换无效

- 症状：AI 回复/玩家消息后未触发媒体切换。
- 解决步骤：
  1. 检查模式：确认「自动切换模式」为「检测播放」（定时模式下不触发检测切换）。
  2. 开关状态：在设置面板勾选「AI 回复时切换」「玩家发送时切换」。
  3. 冷却时间：确认当前时间与上次切换时间间隔超过「切换冷却时间」（默认 3 秒）。
  4. 视频循环：若视频处于循环播放状态，检测切换会临时禁用（关闭循环后恢复）。

### 4. 媒体筛选状态不同步

- 症状：控制栏筛选与设置面板筛选状态不一致。
- 解决步骤：
  1. 点击设置面板「刷新服务」按钮同步状态。
  2. 若仍不同步：关闭 SillyTavern 并重启媒体服务，重新加载扩展。

### 5. WebSocket 连接断开

- 症状：媒体库新增文件后未自动更新。
- 解决步骤：
  1. 检查服务是否正常运行（重启服务可恢复连接）。
  2. 扩展会自动尝试重连（断连后 10 秒触发，无需手动操作）。

## 五、作者信息

- **作者**：DeepSeek、豆包、反死
- **项目地址**：[https://github.com/xs138144-sys/st_image_player.git](https://github.com/xs138144-sys/st_image_player.git)
