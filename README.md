# 媒体播放器扩展（v1.4.1 完整升级版）

基于 SillyTavern 图片播放器脚本的深度重构，安全集成全媒体播放能力，聚焦稳定性修复与功能优化，保留老版本核心交互逻辑，同时解决新版本潜在的脚本崩溃、状态不同步等问题，适配多系统环境。

## 🚀 核心功能亮点

### 1. 全媒体格式支持

- **图片格式**：PNG、JPG、JPEG、GIF、BMP、WebP、APNG
- **视频格式**：WebM、MP4、OGV、MOV、AVI、MKV
- **智能识别**：自动检测媒体类型，无需手动配置

### 2. 播放控制与模式

- **播放模式**：随机播放（自动规避重复媒体）、顺序播放（支持循环切换）
- **自动切换**：AI回复检测、玩家消息检测（优化冷却逻辑，默认3秒防误触）
- **窗口交互**：拖拽移动、四边四角调整大小、锁定功能（防止误操作）
- **过渡效果**：淡入淡出、滑动、缩放、无效果（4种可选）

### 3. 视频专属控制

- **进度管理**：拖拽进度条定位、加载进度可视化
- **音量调节**：0-100%精细控制（静音/低音量/高音量图标区分）
- **循环播放**：独立开关（开启后不触发自动切换）
- **控制栏自定义**：可隐藏进度条、音量控制、循环按钮、时间戳

### 4. 媒体筛选与管理

- **一键筛选**：控制栏快速切换「所有媒体/仅图片/仅视频」
- **大小限制**：自定义图片（1-50MB）、视频（10-500MB）最大尺寸
- **无效清理**：一键移除不存在/超限制的媒体文件

### 5. 视觉与交互优化

- **无边框模式**：仅显示媒体内容，鼠标悬浮显示控制栏（3秒自动隐藏）
- **媒体信息显示**：底部显示文件名与类型（可开关）
- **自适应模式**：填充模式/自适应模式切换

### 6. 观看记录管理

- **自动记录**：启用观看记录后自动记录媒体文件观看历史
- **统计显示**：实时显示媒体文件总数、已观看数、未观看数
- **批量删除**：支持按时间、观看次数等条件批量删除已观看文件
- **智能清理**：自动清理不存在的文件记录和旧记录
- **强制清理**：路径匹配失败时自动清理无效记录

### 7. 性能与稳定性

- **预加载策略**：图片默认预加载、视频可选预加载
- **WebSocket实时更新**：媒体库变更自动同步（断连后10秒自动重连）
- **服务轮询**：可自定义轮询间隔（默认30秒）

## 📦 安装部署

### 1. 扩展部署

将扩展文件夹放入 SillyTavern 的 **`public\scripts\extensions\third-party`** 目录（无该目录需手动创建）。
或者通过酒馆扩展下载安装。

### 2. 依赖安装

```bash
# 创建虚拟环境（可选，一般不用，直接安装依赖包就行）
python -m venv venv
# 激活虚拟环境
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate

# 安装依赖包
pip install -r requirements.txt
```

#### 依赖清单

- flask>=2.0.0,<3.0.0
- flask-cors>=3.0.10,<4.0.0
- watchdog>=2.1.6,<3.0.0（文件监控）
- gevent>=23.9.1,<24.0.0（WebSocket服务）
- gevent-websocket>=0.10.1,<1.0.0
- urllib3>=1.26.0,<2.0.0
- send2trash>=1.8.0,<2.0.0（安全删除文件到回收站）
- pystray>=0.19.4,<1.0.0（系统托盘支持）
- Pillow>=10.0.0,<11.0.0（图像处理，托盘图标生成）

### 3. 启动媒体服务

打开services.bat，PY服务器会自动隐藏。系统托盘可看见一个图标，从图标关闭会关闭所有的PY服务器。

#### 首次启动配置

- 扫描目录：Windows默认为 `F:\Download`，macOS/Linux默认为 `~/Downloads`
- 大小限制：图片5MB、视频100MB（可在设置中修改）
- 服务验证：访问 `http://127.0.0.1:9000/status`，返回「active: true」即正常

## 🎮 使用说明

### 基础操作指南

| 功能 | 操作方式 | 说明 |
|------|----------|------|
| 窗口移动 | 拖拽标题栏 | 锁定状态下不可移动 |
| 窗口缩放 | 拖拽四边四角手柄 | 锁定状态下不可缩放 |
| 锁定窗口 | 点击标题栏「锁」图标 | 防止误操作 |
| 播放/暂停 | 点击控制栏「播放/暂停」按钮 | 图片触发定时切换，视频控制播放状态 |
| 切换媒体 | 点击「上一个/下一个」按钮 | 视频会暂停当前播放 |
| 切换播放模式 | 点击「随机/顺序」图标 | 随机模式重置已播放记录 |
| 筛选媒体类型 | 控制栏右侧「胶片/图片/视频」图标 | 状态同步到设置面板 |
| 无边框模式 | 标题栏「边框」图标 | 鼠标悬浮显示控制栏 |
| 控制栏自定义 | 控制栏「滑块」图标 | 自定义显示/隐藏控制项 |

### 视频播放注意事项

- **浏览器自动播放限制**：需手动点击视频触发首次播放
- **大视频优化**：超过200MB建议关闭「视频预加载」
- **循环播放逻辑**：开启后AI/玩家消息检测不会触发切换
- **断点续传**：刷新页面后从上次播放位置继续

### 高级设置（扩展设置面板）

1. **服务配置**：
   - 服务地址：默认 `http://localhost:9000`
   - 扫描目录：支持中文路径，点击「更新目录」重新扫描

2. **播放设置**：
   - 定时切换间隔：1000-60000毫秒（默认5000毫秒）
   - 检测冷却时间：1000-30000毫秒（默认3000毫秒）
   - 过渡效果：4种动画可选

3. **观看记录管理**：
   - **启用观看记录**：开启后自动记录媒体文件观看历史
   - **自动标记已观看**：观看媒体后自动标记为已观看
   - **观看统计**：实时显示媒体文件统计信息
   - **批量删除已观看**：按条件批量删除已观看文件
   - **清理旧记录**：清理指定天数前的观看记录

4. **视觉与交互**：
   - 隐藏边框：无边框模式开关
   - 显示媒体信息：底部信息显示开关
   - 视频控制栏自定义：按需显示控件

## 🔧 故障排查

### 常见问题解决方案

#### 1. 服务连接失败

- 症状：设置面板显示「服务离线」
- 解决：确认PY服务器已启动，检查服务地址，重启服务

#### 2. 视频加载失败

- 症状：视频显示空白或提示「加载失败」
- 解决：检查文件路径、文件完整性、浏览器兼容性、大小限制

#### 3. 自动切换无效

- 症状：AI回复/玩家消息后未触发媒体切换
- 解决：检查模式、开关状态、冷却时间、视频循环状态

#### 4. 媒体筛选状态不同步

- 症状：控制栏筛选与设置面板状态不一致
- 解决：点击「刷新服务」按钮同步状态

#### 5. WebSocket连接断开

- 症状：媒体库新增文件后未自动更新
- 解决：服务会自动重连（断连后10秒触发）

#### 6. 观看记录统计不更新

- 症状：已观看统计显示为0或未实时更新
- 解决：检查是否启用观看记录功能，刷新页面，查看控制台调试信息

#### 7. 批量删除后统计异常

- 症状：删除文件后已观看统计未正确更新
- 解决：系统会自动清理无效记录，等待强制清理机制生效或手动刷新

#### 8. 观看记录为空

- 症状：查看观看记录显示无记录
- 解决：确认观看记录功能已启用，检查localStorage中的记录数据

## 🎯 v1.4.1 更新内容

### 新增功能

- ✅ **观看记录管理系统**：自动记录媒体文件观看历史，支持统计显示和批量管理
- ✅ **批量删除已观看文件**：智能筛选和删除已观看的媒体文件，支持多种筛选条件
- ✅ **实时统计显示**：动态显示媒体文件总数、已观看数、未观看数
- ✅ **观看记录清理**：支持清理旧记录和无效文件记录
- ✅ **强制清理机制**：路径匹配失败时自动清理不存在的文件记录

### 功能优化

- ✅ **控制栏自定义设置持久化**：窗口重新加载时自动恢复设置
- ✅ **无边框模式交互初始化**：窗口加载时立即生效控制栏自动隐藏/显示
- ✅ **重复按钮修复**：删除重复的控制栏自定义按钮
- ✅ **设置同步优化**：改进UI状态同步机制

### 稳定性提升

- ✅ **错误处理增强**：完善关键操作的错误边界处理
- ✅ **初始化流程优化**：确保所有功能在窗口加载时正确初始化
- ✅ **代码结构清理**：删除冗余代码，提升可维护性

## 📞 技术支持

- **项目地址**：[https://github.com/xs138144-sys/st_image_player.git](https://github.com/xs138144-sys/st_image_player.git)
- **作者**：DeepSeek、豆包、反死
- **版本**：v1.4.1（完整优化版）

---

**注意**：本扩展专为 SillyTavern 设计，确保使用兼容的 SillyTavern 版本以获得最佳体验。
