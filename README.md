# 媒体播放器扩展（老版本迭代版）

基于老版本图片播放器（v1.3.0）重构，安全集成新版本（v1.4.0）的全媒体播放功能，保留老版本稳定核心，去除冗余逻辑，修复已知 BUG。

## 功能说明

### 1. 核心功能（保留老版本稳定特性）

- **本地媒体播放**：支持图片（PNG/JPG/GIF/APNG/WebP）+ 视频（WebM/MP4/OGV/MKV/AVI/MOV）
- **基础播放控制**：
  - 随机/顺序播放模式（逻辑与老版本保持一致）
  - AI 回复/玩家消息检测自动切换（优化冷却逻辑，避免误触发）
  - 窗口锁定/拖拽/Resize（保留原交互体验）
  - 图片过渡效果（淡入淡出/滑动/缩放，无新增冗余效果）

### 2. 新增功能（安全集成，无复杂依赖）

- **视频专属控制**：
  - 进度条拖拽定位（支持断点续传）
  - 音量精细调节（0-100%）
  - 视频循环播放（独立开关，不影响图片逻辑）
  - 自定义控制栏（可隐藏进度条/音量/时间戳）
- **媒体筛选**：控制栏右侧一键切换「所有媒体/仅图片/仅视频」
- **边框隐藏模式**：仅显示媒体内容，鼠标悬浮显示控制栏（无操作 3 秒自动隐藏）
- **媒体大小限制**：可自定义图片（1-50MB）、视频（10-500MB）最大尺寸

## 安装步骤（与老版本兼容）

1. **本地部署**：将扩展文件夹放入 SillyTavern 的 `public\scripts\extensions\third-party` 目录
2. **依赖安装**：执行 `pip install -r requirements.txt`（建议使用 Python 虚拟环境）
3. **启动服务**：运行 `python image_service.py`
   - 首次启动默认扫描 `F:\Download`，可在扩展设置中修改目录
   - 默认限制：图片 5MB、视频 100MB，可在设置中调整

## 使用说明

### 1. 基础操作

- **窗口控制**：拖拽标题栏移动，右下角手柄调整大小，点击「锁」图标锁定窗口
- **播放控制**：
  - 「播放/暂停」：图片触发定时切换，视频直接控制播放状态
  - 「上一个/下一个」：切换媒体（视频会暂停当前播放）
  - 「模式切换」：点击「随机/顺序」图标切换播放模式

### 2. 视频播放注意事项

- **浏览器限制**：Chrome 等浏览器需手动点击视频触发首次播放（自动播放政策限制）
- **性能优化**：大视频（>200MB）建议关闭「视频预加载」，低配置设备关闭「实时 WebSocket 连接」
- **循环播放**：开启后视频重复播放，AI/玩家消息检测切换会临时禁用（避免打断播放）

### 3. 高级设置

- **媒体目录配置**：在设置面板输入本地文件夹路径，点击「更新目录」触发扫描
- **控制栏自定义**：勾选「显示进度条/音量控制」等选项，自定义视频控制栏显示内容
- **边框隐藏**：勾选「隐藏播放器边框」，仅保留媒体内容（适合全屏展示）

## 故障排查（精简版，聚焦高频问题）

1. **服务连接失败**：
   - 检查 `image_service.py` 是否启动，服务地址是否为 `http://localhost:9000`
   - 重启服务后点击设置面板「刷新服务」按钮
2. **视频加载失败**：
   - 检查文件路径是否含中文/特殊字符，文件是否损坏
   - 确认浏览器支持该格式（推荐优先使用 WebM/MP4）
3. **自动切换无效**：
   - 检查是否开启「视频循环」（循环时切换禁用）
   - 确认「自动切换模式」为「检测播放」，且 AI/玩家检测开关已启用

## 版本说明

- **v1.4.1（修复优化版）**：修复代码结构问题（移除函数外重复事件绑定、解决变量作用域冲突），优化定时器稳定性，排除脚本崩溃风险，提升整体运行流畅度；
- **v1.4.0（迭代版）**：基于老版本 v1.3.0 重构，安全集成视频播放/媒体筛选功能，修复新版本 BUG；
- **v1.3.0（基础版）**：原图片播放器，保留核心稳定逻辑

## 作者

DeepSeek 和豆包和反死
