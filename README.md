# 媒体播放器扩展（v1.4.2）

基于 SillyTavern 开发的全媒体播放扩展，支持图片与视频的播放控制、AI 事件联动及实时媒体库同步，聚焦稳定性与多场景适配。

## 一、核心功能

### 1. 全媒体格式支持

- **图片**：PNG、JPG、JPEG、GIF、BMP、WebP、APNG
- **视频**：WebM、MP4、OGV、MOV、AVI、MKV

### 2. 播放控制与交互

- **基础操作**：

  - 播放模式：顺序播放（支持循环）、随机播放（自动规避重复）
  - 切换方式：手动切换（上一个/下一个）、定时切换（可自定义间隔）、AI 事件触发（AI 回复/玩家发言检测）
  - 窗口控制：拖拽标题栏移动、右下角手柄缩放、锁定功能（防止误触）

- **视频专属功能**：
  - 进度管理：拖拽进度条定位、加载进度可视化
  - 音量调节：0-100%精细控制（含静音状态切换）
  - 循环播放：独立开关（开启后不受自动切换影响）
  - 控制栏自定义：可按需隐藏进度条、音量控件等

### 3. 媒体库管理

- **实时同步**：通过 WebSocket 监听媒体文件新增/删除/修改，断连后 10 秒自动重连
- **筛选功能**：一键切换「所有媒体/仅图片/仅视频」，状态全局同步
- **大小限制**：自定义图片（1-50MB）、视频（10-500MB）最大尺寸，超限制文件自动过滤
- **无效清理**：一键移除不存在或超限的媒体文件（操作前弹窗确认）

### 4. 性能与视觉优化

- **预加载策略**：图片默认预加载，视频可选预加载（大文件建议关闭）
- **过渡效果**：图片切换支持淡入淡出、滑动、缩放、无效果（适配低配置设备）
- **边框隐藏**：仅显示媒体内容，鼠标悬浮时显示控制栏（3 秒无操作自动隐藏）
- **信息显示**：底部可显示文件名与类型（支持关闭以避免遮挡内容）

## 二、安装步骤（兼容 Windows/macOS/Linux）

### 1. 扩展部署

将扩展文件夹放入 SillyTavern 的 `public\scripts\extensions\third-party` 目录（无该目录需手动创建）。

### 2. 依赖安装

1. 建议使用 Python 虚拟环境（避免依赖冲突）：

   ```bash
   # 创建虚拟环境
   python -m venv venv
   # 激活虚拟环境
   # Windows:
   venv\Scripts\activate
   # macOS/Linux:
   source venv/bin/activate
   ```

2. 安装依赖包：
   ```bash
   pip install -r requirements.txt
   ```
   依赖清单（版本范围已锁定）：
   - flask>=2.0.0,<3.0.0
   - flask-cors>=3.0.10,<4.0.0
   - watchdog>=2.1.6,<3.0.0（文件监控）
   - gevent>=23.9.1,<24.0.0（WebSocket 服务）
   - gevent-websocket>=0.10.1,<1.0.0
   - urllib3>=1.26.0,<2.0.0

### 3. 启动媒体服务

1. 运行服务脚本：

   ```bash
   python image_service.py
   ```

2. 首次启动默认配置：

   - 扫描目录：Windows 默认为`F:\Download`，macOS/Linux 默认为`~/Downloads`
   - 大小限制：图片 5MB、视频 100MB（可在扩展设置中修改）

3. 服务验证：启动后访问 `http://127.0.0.1:9000/status`，返回「active: true」即表示服务正常。

## 三、使用说明

### 1. 基础操作

| 功能         | 操作方式                                                                |
| ------------ | ----------------------------------------------------------------------- |
| 窗口移动     | 拖拽标题栏（锁定状态下不可移动）                                        |
| 窗口缩放     | 拖拽右下角调整手柄（锁定状态下不可缩放）                                |
| 锁定窗口     | 点击标题栏「锁」图标（锁定后隐藏拖拽/缩放功能）                         |
| 播放/暂停    | 点击控制栏「播放/暂停」按钮（图片触发定时切换，视频控制播放状态）       |
| 切换媒体     | 点击「上一个/下一个」按钮（视频切换后需重新点击播放）                   |
| 切换播放模式 | 点击「随机/顺序」图标（随机模式重置已播放记录，顺序模式从当前索引继续） |
| 筛选媒体类型 | 控制栏右侧「胶片/图片/视频」图标（状态同步到设置面板与扩展菜单）        |

### 2. 视频播放注意事项

- **浏览器限制**：Chrome、Edge 等浏览器需手动点击视频触发首次播放（政策限制无法绕过）。
- **大文件优化**：超过 200MB 的视频建议关闭「视频预加载」，低配置设备可降低轮询频率。
- **循环逻辑**：开启视频循环后，AI/玩家消息检测不会触发切换（避免打断播放，关闭循环后恢复）。
- **断点续传**：视频支持断点续传（刷新页面或重新加载后从上次位置继续）。

### 3. 高级设置（扩展设置面板）

1. **服务配置**：

   - 服务地址：默认`http://localhost:9000`（修改服务端口需同步更新）
   - 扫描目录：输入本地文件夹路径，点击「更新目录」触发重新扫描（支持中文路径）

2. **播放设置**：

   - 定时切换间隔：1000-60000 毫秒（默认 5000 毫秒）
   - 检测冷却时间：1000-30000 毫秒（默认 3000 毫秒，防止短时间内多次切换）
   - 过渡效果：选择图片切换动画（无效果最流畅，适合低配置设备）

3. **视觉与交互**：
   - 隐藏边框：勾选后仅显示媒体内容（鼠标悬浮显示控制栏）
   - 显示媒体信息：底部显示文件名与类型（可关闭以避免遮挡）
   - 视频控制栏自定义：按需勾选需显示的控件（简化界面）

## 四、故障排查

### 1. 服务连接失败

- 症状：扩展提示「服务未运行」或无法加载媒体列表。
- 解决：
  1. 确认`image_service.py`已启动且无报错。
  2. 检查服务地址是否正确（默认`http://localhost:9000`）。
  3. 验证`http://127.0.0.1:9000/status`是否返回正常状态。

### 2. 视频加载失败

- 症状：视频显示空白或提示「加载失败」。
- 解决：
  1. 检查文件路径：避免特殊字符（如`*`、`?`），建议使用英文路径。
  2. 确认文件完整性：用本地播放器（如 VLC）验证文件是否损坏。
  3. 浏览器兼容性：优先使用 WebM/MP4 格式（OGV/MKV 部分浏览器支持不佳）。
  4. 大小限制：确认视频未超过设置的最大尺寸（默认 100MB，可在设置中调整）。

### 3. WebSocket 连接断开

- 症状：媒体库新增文件后未自动更新。
- 解决：
  1. 检查服务是否正常运行（重启服务可恢复连接）。
  2. 扩展会自动重连（断连后 10 秒触发，无需手动操作）。

### 4. 媒体筛选状态不同步

- 症状：控制栏与设置面板的筛选状态不一致。
- 解决：刷新 SillyTavern 页面或在设置面板重新选择筛选类型并保存。

## 五、作者信息

- **作者**：DeepSeek、豆包、反死
- **项目地址**：[https://github.com/xs138144-sys/st_image_player.git]
